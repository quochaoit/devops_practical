trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'HaoACRConn'
  containerRegistry: 'devopacr.azurecr.io'
  buildContextPath: 'docker-demo/src'
  tag: '$(Build.BuildId)'

steps:
# Checkout the source code
- checkout: self
  displayName: 'Checkout source code'

# Log in to Azure Container Registry
- task: Docker@2
  displayName: 'Login to ACR'
  inputs:
    command: 'login'
    containerRegistry: '$(dockerRegistryServiceConnection)'

# Build and push backend image
- task: Docker@2
  displayName: 'Build and Push backend image to ACR'
  inputs:
    containerRegistry: '$(dockerRegistryServiceConnection)'
    repository: 'backend'
    command: 'buildAndPush'
    Dockerfile: '$(buildContextPath)/backend/Dockerfile'
    buildContext: '$(buildContextPath)/backend'
    tags: |
      $(tag)
      latest

# Build and push frontend image
- task: Docker@2
  displayName: 'Build and Push Frontend image to ACR'
  inputs:
    containerRegistry: '$(dockerRegistryServiceConnection)'
    repository: 'frontend'
    command: 'buildAndPush'
    Dockerfile: '$(buildContextPath)/frontend/Dockerfile'
    buildContext: '$(buildContextPath)/frontend'
    tags: |
      $(tag)
      latest

# Verify images exist (manual fail check)
- script: |
    echo "Verifying images exist in ACR..."
    az acr repository show-tags --name devopacr --repository backend --output table || exit 1
    az acr repository show-tags --name devopacr --repository frontend --output table || exit 1
  displayName: 'Verify ACR images'
