trigger: none
  # branches:
  #   include:
  #     - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'HaoACRConn'
  buildContextPath: 'docker-demo/src'
  tag: '$(Build.BuildId)'

stages:
- stage: CIStage
  displayName: CI stage

  jobs:
  - job: BuildAndPush
    displayName: Build & Push Image

    steps:
    - checkout: self
      displayName: 'Checkout source code'

    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: 'login'
        containerRegistry: '$(dockerRegistryServiceConnection)'

    - task: Docker@2
      displayName: 'Build and Push backend image to ACR'
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: 'backend'
        command: 'buildAndPush'
        Dockerfile: '$(buildContextPath)/backend/Dockerfile'
        buildContext: '$(buildContextPath)/backend'
        tags: |
          $(tag)
          latest

    # Build and push frontend image
    - task: Docker@2
      displayName: 'Build and Push Frontend image to ACR'
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: 'frontend'
        command: 'buildAndPush'
        Dockerfile: '$(buildContextPath)/frontend/Dockerfile'
        buildContext: '$(buildContextPath)/frontend'
        tags: |
          $(tag)
          latest

