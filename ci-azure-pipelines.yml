trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'HaoACRConn'
  containerRegistry: 'devopacr.azurecr.io'
  tag: '$(Build.BuildId)'
  buildContextPath: 'docker-demo/src'

steps:
# Checkout the source code
- checkout: self
  displayName: 'Checkout source code'

# Log in to Azure Container Registry
- task: Docker@2
  displayName: 'Login to ACR'
  inputs:
    command: 'login'
    containerRegistry: '$(dockerRegistryServiceConnection)'

# Build and push backend image
- task: Docker@2
  displayName: 'Build and Push image to ACR'
  inputs:
    containerRegistry: '$(dockerRegistryServiceConnection)'
    repository: 'backend'
    command: 'buildAndPush'
    Dockerfile: '$(buildContextPath)/backend/Dockerfile'
    buildContext: '$(buildContextPath)/backend'
    tags: |
      $(tag)
      latest

# Build and push frontend image
- task: Docker@2
  displayName: 'Build and Push Frontend'
  inputs:
    containerRegistry: '$(dockerRegistryServiceConnection)'
    repository: 'frontend'
    command: 'buildAndPush'
    Dockerfile: '$(buildContextPath)/frontend/Dockerfile'
    buildContext: '$(buildContextPath)/frontend'
    tags: |
      $(tag)
      latest

# Optional: Run unit tests
- script: |
    echo "Running backend tests..."
    docker run --rm $(containerRegistry)/backend:$(tag) npm test
  displayName: 'Run unit tests backend inside container'
